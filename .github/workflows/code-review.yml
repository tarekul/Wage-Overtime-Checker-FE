name: Code Review

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Dependencies
        run: npm install

      - name: Get PR Diff / Files Changed
        id: diff
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            BASE=${{ github.base_ref }}
            git fetch origin $BASE --depth=1
            git diff --name-only origin/$BASE > changed_files.txt
          else 
            # push event -> compare against previous commit
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          fi

          echo "Changed files:"
          cat changed_files.txt

          printf "CHANGED_FILES='%s'\n" "$(cat changed_files.txt)" >> $GITHUB_ENV

      - name: Run ESLint
        run: |
          npm run lint -- $(cat changed_files.txt) || echo "No changed files to lint"
